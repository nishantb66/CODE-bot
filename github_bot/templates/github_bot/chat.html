{% extends "github_bot/base.html" %}

{% block title %}GitHub Assistant{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
<style>
    /* Elegant markdown styling */
    .markdown-body {
        line-height: 1.7;
        color: #374151;
    }

    .markdown-body ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin: 0.75em 0;
    }

    .markdown-body ol {
        list-style-type: decimal;
        padding-left: 1.5em;
        margin: 0.75em 0;
    }

    .markdown-body li {
        margin: 0.35em 0;
    }

    .markdown-body p {
        margin: 0.75em 0;
    }

    .markdown-body strong {
        font-weight: 600;
        color: #111827;
    }

    .markdown-body code {
        background: #f1f5f9;
        color: #0f172a;
        padding: 0.25em 0.5em;
        border-radius: 0.375rem;
        font-size: 0.9em;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-weight: 500;
    }

    .user-message .markdown-body code {
        background: rgba(255, 255, 255, 0.25);
        color: white;
    }

    .markdown-body pre {
        background: #1e293b;
        color: #e2e8f0;
        padding: 1.25em;
        border-radius: 0.75rem;
        overflow-x: auto;
        margin: 1em 0;
        border: 1px solid #334155;
    }

    .markdown-body pre code {
        background: transparent;
        color: inherit;
        padding: 0;
        font-weight: 400;
    }

    .markdown-body h2 {
        font-weight: 600;
        font-size: 1.25em;
        margin: 1.5em 0 0.75em;
        color: #111827;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 0.5em;
    }

    .markdown-body h3 {
        font-weight: 600;
        font-size: 1.1em;
        margin: 1.25em 0 0.5em;
        color: #374151;
    }

    /* Elegant message animations */
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-enter {
        animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Typing cursor */
    .typing-cursor {
        display: inline-block;
        width: 2px;
        height: 1em;
        background: #22c55e;
        margin-left: 2px;
        animation: blink 1s infinite;
    }

    @keyframes blink {

        0%,
        49% {
            opacity: 1;
        }

        50%,
        100% {
            opacity: 0;
        }
    }

    /* Typing Indicator */
    .typing-indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 12px 16px;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10b981;
        animation: typingDot 1.4s infinite;
        opacity: 0.4;
    }

    .typing-indicator span:nth-child(1) {
        animation-delay: 0s;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typingDot {

        0%,
        60%,
        100% {
            opacity: 0.4;
            transform: scale(1);
        }

        30% {
            opacity: 1;
            transform: scale(1.2);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <!-- Elegant Header -->
    <header class="bg-white/80 backdrop-blur-md border-b border-gray-200/60 sticky top-0 z-20">
        <div class="max-w-5xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between gap-4">
                <!-- Logo & Title -->
                <div class="flex items-center gap-3">
                    <div
                        class="w-11 h-11 bg-gradient-to-br from-primary-500 to-accent-500 rounded-xl flex items-center justify-center shadow-sm">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                            </path>
                        </svg>
                    </div>
                    <div class="hidden sm:block">
                        <h1 class="text-lg font-semibold text-gray-900">GitHub Assistant</h1>
                        <p class="text-xs text-gray-500">AI-Powered Repository Analysis</p>
                    </div>
                    <h1 class="sm:hidden text-lg font-semibold text-gray-900">GitHub Assistant</h1>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-2">
                    <button id="generateReportBtn"
                        class="px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg hover:shadow-md transition-all flex items-center gap-1.5"
                        title="Generate Repository Report">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <span class="hidden sm:inline">Report</span>
                    </button>
                    <a href="/code-review/"
                        class="px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-primary-500 to-accent-500 rounded-lg hover:shadow-md transition-all">
                        <span class="hidden sm:inline">Code Review</span>
                        <span class="sm:hidden">Review</span>
                    </a>
                    <select id="modelSelect"
                        class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 bg-white transition-all">
                        <option value="2">Llama 3.3 70B</option>
                        <option value="1">Llama 3.1 8B</option>
                    </select>
                    <button id="clearHistoryBtn"
                        class="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-all"
                        title="Clear chat">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                    </button>

                    <!-- User Menu -->
                    <div class="relative" id="userMenuContainer">
                        <!-- Authenticated User -->
                        <div id="authenticatedUser" class="hidden">
                            <button id="userMenuBtn"
                                class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-all">
                                <div
                                    class="w-8 h-8 bg-gradient-to-br from-primary-500 to-accent-500 rounded-full flex items-center justify-center text-white font-semibold text-xs">
                                    <span id="userInitials">U</span>
                                </div>
                                <span id="userName" class="hidden md:inline"></span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>

                            <!-- Dropdown Menu -->
                            <div id="userDropdown"
                                class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border border-gray-200 py-2 z-50">
                                <div class="px-4 py-3 border-b border-gray-100">
                                    <p class="text-sm font-medium text-gray-900" id="dropdownUserName"></p>
                                    <p class="text-xs text-gray-500" id="dropdownUserEmail"></p>
                                </div>
                                <button id="changePasswordBtn"
                                    class="w-full flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z">
                                        </path>
                                    </svg>
                                    Change Password
                                </button>
                                <button id="logoutBtn"
                                    class="w-full flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                                        </path>
                                    </svg>
                                    Logout
                                </button>
                            </div>
                        </div>

                        <!-- Guest User  -->
                        <div id="guestUser" class="flex items-center gap-2">
                            <a href="/auth/login/"
                                class="px-3 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-all">
                                Login
                            </a>
                            <a href="/auth/signup/"
                                class="px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-primary-500 to-accent-500 rounded-lg hover:shadow-md transition-all">
                                Sign Up
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Messages Area -->
    <main class="flex-1 overflow-y-auto">
        <div class="max-w-4xl mx-auto px-4 py-6" id="messagesContainer">
            <!-- Welcome Message -->
            <div id="welcomeMessage" class="text-center py-16 sm:py-20">
                <div
                    class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-primary-100 to-accent-100 rounded-3xl mb-6 shadow-sm">
                    <svg class="w-10 h-10 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                        </path>
                    </svg>
                </div>
                <h2 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-3">Welcome</h2>
                <p class="text-gray-600 mb-10 max-w-md mx-auto text-lg">Ask me anything about your GitHub repositories
                </p>

                <!-- Quick Actions -->
                <div class="flex flex-wrap gap-3 justify-center max-w-2xl mx-auto">
                    <button
                        class="suggestion-btn px-5 py-2.5 bg-white border border-gray-200 rounded-xl text-sm text-gray-700 hover:border-primary-300 hover:bg-primary-50/50 hover:text-primary-700 transition-all shadow-sm hover:shadow">
                        What repositories do I have?
                    </button>
                    <button
                        class="suggestion-btn px-5 py-2.5 bg-white border border-gray-200 rounded-xl text-sm text-gray-700 hover:border-primary-300 hover:bg-primary-50/50 hover:text-primary-700 transition-all shadow-sm hover:shadow">
                        Show my most popular repo
                    </button>
                    <button
                        class="suggestion-btn px-5 py-2.5 bg-white border border-gray-200 rounded-xl text-sm text-gray-700 hover:border-primary-300 hover:bg-primary-50/50 hover:text-primary-700 transition-all shadow-sm hover:shadow">
                        What languages do I use?
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <footer class="bg-white/80 backdrop-blur-md border-t border-gray-200/60 sticky bottom-0">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <form id="chatForm" class="flex gap-3">
                <textarea id="promptInput" rows="1" placeholder="Ask about your repositories..."
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 resize-none text-sm sm:text-base transition-all shadow-sm"
                    style="max-height: 120px;"></textarea>
                <button type="submit" id="sendBtn"
                    class="px-5 sm:px-6 py-3 bg-gradient-to-r from-primary-500 to-accent-500 hover:from-primary-600 hover:to-accent-600 text-white rounded-xl font-medium transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-sm hover:shadow-md flex-shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </form>
        </div>
    </footer>

    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full shadow-2xl">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin"></div>
                <div>
                    <p class="font-semibold text-gray-900 text-lg">Processing...</p>
                    <p class="text-sm text-gray-500">Analyzing repositories</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Generation Modal -->
    <div id="reportModal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-purple-500 to-pink-500 px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-white">Generate Repository Report</h2>
                        <p class="text-sm text-white/80">Create a comprehensive PDF report</p>
                    </div>
                </div>
                <button id="closeReportModal" class="text-white/80 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Input Section -->
                <div id="reportInputSection">
                    <div class="mb-6">
                        <label for="repoUrlInput" class="block text-sm font-medium text-gray-700 mb-2">
                            Repository URL
                        </label>
                        <div class="flex gap-3">
                            <input type="url" id="repoUrlInput" placeholder="https://github.com/owner/repository"
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500 transition-all">
                            <button id="generateBtn"
                                class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Generate
                            </button>
                        </div>
                        <p class="mt-2 text-sm text-gray-500">
                            Enter a public GitHub repository URL to generate a detailed analysis report
                        </p>
                    </div>

                    <!-- Examples -->
                    <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-4 border border-purple-100">
                        <p class="text-sm font-medium text-gray-700 mb-2">üìå Example URLs:</p>
                        <div class="space-y-1">
                            <button class="example-url text-sm text-purple-600 hover:text-purple-700 block">
                                https://github.com/torvalds/linux
                            </button>
                            <button class="example-url text-sm text-purple-600 hover:text-purple-700 block">
                                https://github.com/facebook/react
                            </button>
                            <button class="example-url text-sm text-purple-600 hover:text-purple-700 block">
                                https://github.com/microsoft/vscode
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="reportLoadingSection" class="hidden text-center py-12">
                    <div
                        class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-purple-100 to-pink-100 rounded-full mb-4">
                        <div class="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin">
                        </div>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">ü§ñ AI Analysis in Progress...</h3>
                    <p class="text-sm text-gray-500">Analyzing repository with Llama 3.3 70B</p>
                    <p class="text-xs text-gray-400 mt-2">This may take 10-20 seconds</p>
                </div>

                <!-- Preview Section -->
                <div id="reportPreviewSection" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Report Preview</h3>
                        <button id="downloadReportBtn"
                            class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download PDF
                        </button>
                    </div>
                    <div class="bg-gray-100 rounded-lg p-2 border border-gray-200">
                        <iframe id="pdfPreview" class="w-full h-[500px] bg-white rounded"></iframe>
                    </div>
                    <div class="mt-4 flex justify-center">
                        <button id="generateAnotherBtn"
                            class="px-4 py-2 text-purple-600 hover:text-purple-700 font-medium transition-colors">
                            ‚Üê Generate Another Report
                        </button>
                    </div>
                </div>

                <!-- Error Section -->
                <div id="reportErrorSection" class="hidden">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                        <div class="inline-flex items-center justify-center w-12 h-12 bg-red-100 rounded-full mb-3">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-red-900 mb-2">Error Generating Report</h3>
                        <p id="reportErrorMessage" class="text-sm text-red-700 mb-4"></p>
                        <button id="tryAgainBtn"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors">
                            Try Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    marked.use({ breaks: true, gfm: true });

    let conversationId = null;
    let isLoading = false;
    let currentStreamingMessage = null;
    let currentUser = null;

    const chatForm = document.getElementById('chatForm');
    const promptInput = document.getElementById('promptInput');
    const messagesContainer = document.getElementById('messagesContainer');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const sendBtn = document.getElementById('sendBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const modelSelect = document.getElementById('modelSelect');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');

    // ===== Authentication Management =====
    const authenticatedUser = document.getElementById('authenticatedUser');
    const guestUser = document.getElementById('guestUser');
    const userMenuBtn = document.getElementById('userMenuBtn');
    const userDropdown = document.getElementById('userDropdown');
    const logoutBtn = document.getElementById('logoutBtn');

    // Check authentication status
    async function checkAuth() {
        try {
            const response = await fetch('/api/auth/api/me/', {
                credentials: 'include'
            });

            if (response.ok) {
                currentUser = await response.json();
                updateUserUI(currentUser);
            } else {
                showGuestUI();
            }
        } catch (error) {
            console.error('Auth check error:', error);
            showGuestUI();
        }
    }

    // Update UI for authenticated user
    function updateUserUI(user) {
        authenticatedUser.classList.remove('hidden');
        guestUser.classList.add('hidden');

        // Set user initials
        const initials = user.first_name && user.last_name
            ? (user.first_name[0] + user.last_name[0]).toUpperCase()
            : user.username.substring(0, 2).toUpperCase();
        document.getElementById('userInitials').textContent = initials;

        // Set user name
        const displayName = user.full_name || user.username;
        document.getElementById('userName').textContent = displayName;
        document.getElementById('dropdownUserName').textContent = displayName;
        document.getElementById('dropdownUserEmail').textContent = user.email;
    }

    // Show guest UI
    function showGuestUI() {
        authenticatedUser.classList.add('hidden');
        guestUser.classList.remove('hidden');
    }

    // Toggle user dropdown
    userMenuBtn?.addEventListener('click', function (e) {
        e.stopPropagation();
        userDropdown.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function (e) {
        if (!userDropdown.classList.contains('hidden') && !userMenuBtn?.contains(e.target)) {
            userDropdown.classList.add('hidden');
        }
    });

    // Handle logout
    logoutBtn?.addEventListener('click', async function () {
        try {
            await fetch('/api/auth/api/logout/', {
                method: 'POST',
                credentials: 'include'
            });
            window.location.href = '/auth/login/';
        } catch (error) {
            console.error('Logout error:', error);
            // Force redirect anyway
            window.location.href = '/auth/login/';
        }
    });

    // Check auth on page load
    checkAuth();


    // Auto-resize textarea
    promptInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Handle Enter key
    promptInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!isLoading) chatForm.dispatchEvent(new Event('submit'));
        }
    });

    // Suggestion buttons
    document.querySelectorAll('.suggestion-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            promptInput.value = this.textContent.trim();
            promptInput.focus();
            promptInput.dispatchEvent(new Event('input'));
        });
    });

    // Add message
    function addMessage(content, role = 'user', isStreaming = false) {
        if (welcomeMessage) welcomeMessage.style.display = 'none';

        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} mb-6 message-enter`;

        const bubble = document.createElement('div');
        bubble.className = `max-w-[85%] sm:max-w-[75%] rounded-2xl px-5 py-4 text-sm sm:text-base markdown-body ${role === 'user'
            ? 'bg-gradient-to-r from-primary-500 to-accent-500 text-white user-message shadow-md'
            : 'bg-white border border-gray-200 text-gray-900 shadow-sm'
            }`;

        if (isStreaming) {
            bubble.id = 'streaming-message';
            bubble.innerHTML = content;
        } else {
            try {
                const parsed = marked.parse(content);
                const sanitized = DOMPurify.sanitize(parsed);
                bubble.innerHTML = sanitized;
            } catch (e) {
                bubble.textContent = content;
            }
        }

        messageDiv.appendChild(bubble);
        messagesContainer.appendChild(messageDiv);

        // Smooth scroll to bottom
        const scrollToBottom = (smooth = false) => {
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: smooth ? 'smooth' : 'auto'
            });
        };

        // Initial instant scroll
        scrollToBottom(false);

        // Smooth scroll after render
        requestAnimationFrame(() => {
            scrollToBottom(true);
            setTimeout(() => scrollToBottom(true), 50);
            setTimeout(() => scrollToBottom(true), 150);
        });

        return bubble;
    }

    // Update streaming message
    function updateStreamingMessage(content) {
        const bubble = document.getElementById('streaming-message');
        if (bubble) {
            try {
                const parsed = marked.parse(content);
                const sanitized = DOMPurify.sanitize(parsed);
                bubble.innerHTML = sanitized;
            } catch (e) {
                bubble.textContent = content;
            }

            // Smooth auto-scroll as content streams in
            const scrollToBottom = (smooth = true) => {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: smooth ? 'smooth' : 'auto'
                });
            };

            // Immediate scroll
            scrollToBottom(false);

            // Smooth scroll after render
            requestAnimationFrame(() => {
                scrollToBottom(true);
                setTimeout(() => scrollToBottom(true), 10);
                setTimeout(() => scrollToBottom(true), 50);
            });
        }
    }

    // Show/hide loading
    function setLoading(loading) {
        isLoading = loading;
        sendBtn.disabled = loading;
        if (!loading) {
            loadingOverlay.classList.add('hidden');
        }
    }

    // Show typing indicator
    function showTypingIndicator() {
        if (welcomeMessage) welcomeMessage.style.display = 'none';

        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex justify-start mb-6 message-enter';
        messageDiv.id = 'typing-indicator-wrapper';

        const bubble = document.createElement('div');
        bubble.className = 'max-w-[85%] sm:max-w-[75%] rounded-2xl bg-white border border-gray-200 shadow-sm';

        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator';
        typingIndicator.innerHTML = '<span></span><span></span><span></span>';

        bubble.appendChild(typingIndicator);
        messageDiv.appendChild(bubble);
        messagesContainer.appendChild(messageDiv);

        // Smooth scroll to show typing indicator
        const scrollToBottom = (smooth = true) => {
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: smooth ? 'smooth' : 'auto'
            });
        };

        // Initial instant scroll
        scrollToBottom(false);

        // Smooth scroll after render
        requestAnimationFrame(() => {
            scrollToBottom(true);
            setTimeout(() => scrollToBottom(true), 50);
            setTimeout(() => scrollToBottom(true), 150);
        });
    }

    // Hide typing indicator
    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator-wrapper');
        if (indicator) {
            indicator.remove();
        }
    }

    // Handle form submission with streaming
    chatForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        const prompt = promptInput.value.trim();
        if (!prompt || isLoading) return;

        addMessage(prompt, 'user');
        promptInput.value = '';
        promptInput.style.height = 'auto';
        setLoading(true);

        // Show typing indicator instead of full-screen overlay
        showTypingIndicator();

        try {
            const requestBody = {
                prompt: prompt,
                model_id: parseInt(modelSelect.value)
            };

            if (conversationId) {
                requestBody.conversation_id = conversationId;
            }

            // Use EventSource for Server-Sent Events
            const response = await fetch('/api/chat/stream/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            // Read the stream
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let fullResponse = '';
            let messageBubble = null;

            // Hide typing indicator when stream starts
            hideTypingIndicator();

            while (true) {
                const { done, value } = await reader.read();

                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.slice(6));

                        if (data.type === 'conversation_id') {
                            conversationId = data.conversation_id;
                        } else if (data.type === 'content') {
                            fullResponse += data.content;

                            if (!messageBubble) {
                                messageBubble = addMessage(fullResponse, 'assistant', true);
                            } else {
                                updateStreamingMessage(fullResponse);
                            }
                        } else if (data.type === 'error') {
                            if (!messageBubble) {
                                addMessage(`‚ö†Ô∏è ${data.error}`, 'assistant');
                            }
                        } else if (data.done) {
                            // Streaming complete
                            if (messageBubble) {
                                messageBubble.removeAttribute('id');
                            }
                        }
                    }
                }
            }

        } catch (error) {
            console.error('Error:', error);
            hideTypingIndicator();
            addMessage('‚ö†Ô∏è Sorry, there was an error. Please try again.', 'assistant');
        } finally {
            setLoading(false);
        }
    });

    // Clear history
    clearHistoryBtn.addEventListener('click', async function () {
        const hasMessages = messagesContainer.querySelectorAll('.message-enter').length > 0;

        if (!conversationId && !hasMessages) return;

        if (!confirm('Clear conversation history?')) return;

        try {
            const messages = messagesContainer.querySelectorAll('.message-enter');
            messages.forEach(msg => msg.remove());

            if (welcomeMessage) welcomeMessage.style.display = 'block';

            const currentConversationId = conversationId;
            conversationId = null;

            if (currentConversationId) {
                await fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: 'Clear history',
                        conversation_id: currentConversationId,
                        clear_history: true
                    })
                }).catch(() => { });
            }
        } catch (error) {
            console.error('Error clearing history:', error);
        }
    });

    // ===== Report Generation Modal =====
    const reportModal = document.getElementById('reportModal');
    const generateReportBtn = document.getElementById('generateReportBtn');
    const closeReportModal = document.getElementById('closeReportModal');
    const repoUrlInput = document.getElementById('repoUrlInput');
    const generateBtn = document.getElementById('generateBtn');
    const downloadReportBtn = document.getElementById('downloadReportBtn');
    const generateAnotherBtn = document.getElementById('generateAnotherBtn');
    const tryAgainBtn = document.getElementById('tryAgainBtn');

    const reportInputSection = document.getElementById('reportInputSection');
    const reportLoadingSection = document.getElementById('reportLoadingSection');
    const reportPreviewSection = document.getElementById('reportPreviewSection');
    const reportErrorSection = document.getElementById('reportErrorSection');
    const pdfPreview = document.getElementById('pdfPreview');
    const reportErrorMessage = document.getElementById('reportErrorMessage');

    let currentPdfData = null;
    let currentFilename = null;

    // Open modal
    generateReportBtn.addEventListener('click', () => {
        reportModal.classList.remove('hidden');
        resetReportModal();
        repoUrlInput.focus();
    });

    // Close modal
    closeReportModal.addEventListener('click', () => {
        reportModal.classList.add('hidden');
    });

    // Close on backdrop click
    reportModal.addEventListener('click', (e) => {
        if (e.target === reportModal) {
            reportModal.classList.add('hidden');
        }
    });

    // Example URL clicks
    document.querySelectorAll('.example-url').forEach(btn => {
        btn.addEventListener('click', function () {
            repoUrlInput.value = this.textContent.trim();
            repoUrlInput.focus();
        });
    });

    // Enter key in input
    repoUrlInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            generateBtn.click();
        }
    });

    // Generate report
    generateBtn.addEventListener('click', async () => {
        const repoUrl = repoUrlInput.value.trim();

        if (!repoUrl) {
            alert('Please enter a repository URL');
            return;
        }

        if (!repoUrl.includes('github.com')) {
            alert('Please enter a valid GitHub repository URL');
            return;
        }

        // Show loading
        reportInputSection.classList.add('hidden');
        reportErrorSection.classList.add('hidden');
        reportPreviewSection.classList.add('hidden');
        reportLoadingSection.classList.remove('hidden');

        try {
            const response = await fetch('/api/generate-report/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ repo_url: repoUrl })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to generate report');
            }

            // Store PDF data
            currentPdfData = data.pdf_base64;
            currentFilename = data.filename;

            // Show preview
            const pdfDataUrl = `data:application/pdf;base64,${data.pdf_base64}`;
            pdfPreview.src = pdfDataUrl;

            reportLoadingSection.classList.add('hidden');
            reportPreviewSection.classList.remove('hidden');

        } catch (error) {
            console.error('Error generating report:', error);
            reportErrorMessage.textContent = error.message || 'Failed to generate report. Please try again.';
            reportLoadingSection.classList.add('hidden');
            reportErrorSection.classList.remove('hidden');
        }
    });

    // Download report
    downloadReportBtn.addEventListener('click', () => {
        if (!currentPdfData || !currentFilename) return;

        // Convert base64 to blob
        const byteCharacters = atob(currentPdfData);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'application/pdf' });

        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = currentFilename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    });

    // Generate another report
    generateAnotherBtn.addEventListener('click', () => {
        resetReportModal();
    });

    // Try again
    tryAgainBtn.addEventListener('click', () => {
        resetReportModal();
    });

    // Reset modal to initial state
    function resetReportModal() {
        reportInputSection.classList.remove('hidden');
        reportLoadingSection.classList.add('hidden');
        reportPreviewSection.classList.add('hidden');
        reportErrorSection.classList.add('hidden');
        repoUrlInput.value = '';
        currentPdfData = null;
        currentFilename = null;
    }
</script>
{% endblock %}