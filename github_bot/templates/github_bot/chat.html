{% extends "github_bot/base.html" %}

{% block title %}GitHub Assistant - AI Code Analysis{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
<style>
    /* Markdown Styling */
    .markdown-body {
        line-height: 1.7;
        color: #cbd5e1;
        font-size: 0.9375rem;
    }

    .markdown-body ul {
        list-style-type: disc;
        padding-left: 1.5em;
        margin: 0.75em 0;
    }

    .markdown-body ol {
        list-style-type: decimal;
        padding-left: 1.5em;
        margin: 0.75em 0;
    }

    .markdown-body li {
        margin: 0.375em 0;
    }

    .markdown-body p {
        margin: 0.75em 0;
    }

    .markdown-body strong {
        font-weight: 600;
        color: #f1f5f9;
    }

    .markdown-body code {
        background: rgba(255, 255, 255, 0.1);
        color: #e2e8f0;
        padding: 0.2em 0.4em;
        border-radius: 0.25rem;
        font-size: 0.875em;
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-weight: 500;
    }

    .user-message .markdown-body code,
    .user-message code {
        background: rgba(255, 255, 255, 0.2);
        color: #f1f5f9;
    }

    .ai-message .markdown-body code,
    .ai-message code {
        background: rgba(0, 0, 0, 0.2);
        color: #e2e8f0;
    }

    .markdown-body pre {
        background: #1e293b;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin: 1em 0;
    }

    .markdown-body pre code {
        background: transparent;
        color: inherit;
        padding: 0;
        font-weight: 400;
    }

    .markdown-body h2 {
        font-weight: 600;
        font-size: 1.125em;
        margin: 1.5em 0 0.75em;
        color: #f1f5f9;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 0.5em;
    }

    .markdown-body h3 {
        font-weight: 600;
        font-size: 1em;
        margin: 1.25em 0 0.5em;
        color: #f1f5f9;
    }

    .markdown-body h4,
    .markdown-body h5,
    .markdown-body h6 {
        font-weight: 600;
        color: #e2e8f0;
    }

    .markdown-body a {
        color: #60a5fa;
        text-decoration: none;
        font-weight: 500;
    }

    .markdown-body a:hover {
        text-decoration: underline;
        color: #93c5fd;
    }

    .user-message .markdown-body a {
        color: #93c5fd;
    }

    .user-message .markdown-body a:hover {
        color: #dbeafe;
    }

    /* Message Animations */
    @keyframes messageSlide {
        from {
            opacity: 0;
            transform: translateY(12px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-enter {
        animation: messageSlide 0.25s ease-out;
    }

    /* AI Thinking Indicator */
    .ai-thinking {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
    }

    .ai-thinking-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse-icon 2s ease-in-out infinite;
    }

    .ai-thinking-icon svg {
        width: 18px;
        height: 18px;
        color: white;
    }

    @keyframes pulse-icon {

        0%,
        100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.7;
            transform: scale(0.95);
        }
    }

    .ai-thinking-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .ai-thinking-text {
        font-size: 0.875rem;
        font-weight: 500;
        color: #e2e8f0;
    }

    .ai-thinking-dots {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .ai-thinking-dots span {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #64748b;
        animation: thinkingDot 1.4s infinite;
    }

    .ai-thinking-dots span:nth-child(1) {
        animation-delay: 0s;
    }

    .ai-thinking-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .ai-thinking-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes thinkingDot {

        0%,
        60%,
        100% {
            opacity: 0.3;
            transform: scale(1);
        }

        30% {
            opacity: 1;
            transform: scale(1.2);
        }
    }

    /* Legacy typing indicator for fallback */
    .typing-indicator {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 12px 16px;
    }

    .typing-indicator span {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #94a3b8;
        animation: typingDot 1.4s infinite;
    }

    .typing-indicator span:nth-child(1) {
        animation-delay: 0s;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typingDot {

        0%,
        60%,
        100% {
            opacity: 0.4;
            transform: scale(1);
        }

        30% {
            opacity: 1;
            transform: scale(1.1);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col h-screen">
    <!-- Professional Header -->
    <header class="bg-slate-900/90 border-b border-white/10 sticky top-0 z-20 backdrop-blur-sm">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 py-3">
            <div class="flex items-center justify-between gap-4">
                <!-- Logo & Title -->
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 bg-emerald-500 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-slate-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                            </path>
                        </svg>
                    </div>
                    <div class="hidden sm:block">
                        <h1 class="text-base font-semibold text-slate-50">GitHub Assistant</h1>
                        <p class="text-xs text-slate-400">AI-Powered Analysis</p>
                    </div>
                    <h1 class="sm:hidden text-base font-semibold text-slate-50">GitHub Assistant</h1>
                </div>

                <!-- Right Actions -->
                <div class="flex items-center gap-2">
                    <!-- Navigation Dropdown -->
                    <div class="relative" id="navDropdownContainer">
                        <button id="navDropdownBtn"
                            class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-slate-300 hover:text-slate-50 hover:bg-white/5 rounded-lg transition-colors">
                            <span>Tools</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>

                        <div id="navDropdown"
                            class="hidden dropdown-menu absolute right-0 mt-1 w-48 bg-slate-800 rounded-lg shadow-dropdown border border-white/10 py-1 z-50">
                            <a href="/code-review/"
                                class="flex items-center gap-3 px-4 py-2.5 text-sm text-slate-200 hover:bg-white/10 transition-colors">
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                                </svg>
                                Code Review
                            </a>
                            <a href="/security/"
                                class="flex items-center gap-3 px-4 py-2.5 text-sm text-slate-200 hover:bg-white/10 transition-colors">
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z">
                                    </path>
                                </svg>
                                Security Scanner
                            </a>
                            <a href="/jwt-debugger/"
                                class="flex items-center gap-3 px-4 py-2.5 text-sm text-slate-200 hover:bg-white/10 transition-colors">
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                                JWT Debugger
                            </a>
                            <button id="generateReportBtn"
                                class="w-full flex items-center gap-3 px-4 py-2.5 text-sm text-slate-200 hover:bg-white/10 transition-colors">
                                <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                                Generate Report
                            </button>
                        </div>
                    </div>

                    <!-- Model Selector -->
                    <select id="modelSelect"
                        class="hidden sm:block px-3 py-2 text-sm border border-white/10 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 bg-slate-800 text-slate-200 transition-colors cursor-pointer">
                        <option value="2">Llama 3.3 70B</option>
                        <option value="1">Llama 3.1 8B</option>
                    </select>

                    <!-- Clear Button -->
                    <button id="clearHistoryBtn"
                        class="p-2 text-slate-400 hover:text-slate-200 hover:bg-white/5 rounded-lg transition-colors"
                        title="Clear chat">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                    </button>

                    <!-- User Menu -->
                    <div class="relative" id="userMenuContainer">
                        <div id="authenticatedUser" class="hidden">
                            <button id="userMenuBtn"
                                class="flex items-center gap-2 p-1 hover:bg-white/5 rounded-lg transition-colors">
                                <div
                                    class="w-8 h-8 bg-emerald-500 rounded-lg flex items-center justify-center text-slate-900 font-medium text-sm">
                                    <span id="userInitials">U</span>
                                </div>
                                <svg class="w-4 h-4 text-brand-400 hidden sm:block" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>

                            <div id="userDropdown"
                                class="hidden dropdown-menu absolute right-0 mt-1 w-56 bg-slate-800 rounded-lg shadow-dropdown border border-white/10 py-1 z-50">
                                <div class="px-4 py-3 border-b border-white/10">
                                    <p class="text-sm font-medium text-slate-50" id="dropdownUserName"></p>
                                    <p class="text-xs text-slate-400 mt-0.5" id="dropdownUserEmail"></p>
                                </div>
                                <button id="logoutBtn"
                                    class="w-full flex items-center gap-3 px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                                        </path>
                                    </svg>
                                    Sign Out
                                </button>
                            </div>
                        </div>

                        <!-- Guest User - Hidden since user is authenticated -->
                        <div id="guestUser" class="hidden"></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Messages Area -->
    <main class="flex-1 overflow-y-auto">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 py-6" id="messagesContainer">
            <!-- Welcome Message -->
            <div id="welcomeMessage" class="text-center py-16 sm:py-20">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-slate-800/50 rounded-xl mb-6">
                    <svg class="w-8 h-8 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                            d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                        </path>
                    </svg>
                </div>
                <h2 class="text-2xl sm:text-3xl font-semibold text-slate-50 mb-3">Hello! üëã</h2>
                <p class="text-slate-300 mb-10 max-w-md mx-auto">
                    I'm your AI assistant for GitHub repositories. Ask me anything about your code.
                </p>

                <!-- Quick Actions -->
                <div class="flex flex-wrap gap-2 justify-center max-w-xl mx-auto">
                    <button
                        class="suggestion-btn px-4 py-2.5 bg-slate-800/50 border border-white/10 rounded-lg text-sm text-slate-200 hover:border-white/20 hover:bg-slate-800 transition-colors">
                        What repositories do I have?
                    </button>
                    <button
                        class="suggestion-btn px-4 py-2.5 bg-slate-800/50 border border-white/10 rounded-lg text-sm text-slate-200 hover:border-white/20 hover:bg-slate-800 transition-colors">
                        Show my most popular repo
                    </button>
                    <button
                        class="suggestion-btn px-4 py-2.5 bg-slate-800/50 border border-white/10 rounded-lg text-sm text-slate-200 hover:border-white/20 hover:bg-slate-800 transition-colors">
                        What languages do I use?
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <footer class="bg-slate-900/90 border-t border-white/10 sticky bottom-0 backdrop-blur-sm">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 py-4">
            <form id="chatForm" class="flex gap-3">
                <textarea id="promptInput" rows="1" placeholder="Ask about your repositories..."
                    class="flex-1 px-4 py-3 border border-white/10 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 resize-none text-sm transition-colors bg-slate-800 text-slate-200 placeholder-slate-400"
                    style="max-height: 120px;"></textarea>
                <button type="submit" id="sendBtn"
                    class="btn-hover px-5 py-3 bg-emerald-500 hover:bg-emerald-600 text-slate-900 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </form>
            <p class="text-xs text-slate-500 text-center mt-3">Powered by Llama AI ‚Ä¢ Responses may be inaccurate</p>
        </div>
    </footer>

    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl p-6 max-w-sm w-full shadow-elevated border border-white/10">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 border-3 border-slate-700 border-t-emerald-500 rounded-full animate-spin"></div>
                <div>
                    <p class="font-medium text-slate-50">Processing...</p>
                    <p class="text-sm text-slate-400 mt-0.5">Analyzing repositories</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Generation Modal -->
    <div id="reportModal"
        class="hidden fixed inset-0 bg-brand-900/40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-slate-900 rounded-xl shadow-elevated max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col border border-white/10">
            <!-- Modal Header -->
            <div class="bg-slate-800 px-6 py-4 flex items-center justify-between border-b border-white/10">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-emerald-500/20 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-slate-50">Generate Repository Report</h2>
                        <p class="text-sm text-slate-400">Create a comprehensive PDF analysis</p>
                    </div>
                </div>
                <button id="closeReportModal"
                    class="p-2 text-slate-400 hover:text-slate-200 hover:bg-white/5 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-6 bg-slate-900">
                <!-- Input Section -->
                <div id="reportInputSection">
                    <div class="mb-6">
                        <label for="repoUrlInput" class="block text-sm font-medium text-slate-300 mb-2">
                            Repository URL
                        </label>
                        <div class="flex gap-3">
                            <input type="url" id="repoUrlInput" placeholder="https://github.com/owner/repository"
                                class="flex-1 px-4 py-3 border border-white/10 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-colors bg-slate-800 text-slate-200 placeholder-slate-500">
                            <button id="generateBtn"
                                class="btn-hover px-6 py-3 bg-emerald-500 text-slate-900 rounded-lg font-medium hover:bg-emerald-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Generate
                            </button>
                        </div>
                        <p class="mt-2 text-sm text-slate-400">
                            Enter a public GitHub repository URL to generate a detailed analysis report
                        </p>
                    </div>

                    <!-- Examples -->
                    <div class="bg-slate-800/50 rounded-lg p-4 border border-white/10">
                        <p class="text-sm font-medium text-slate-300 mb-2">Example URLs:</p>
                        <div class="space-y-1">
                            <button
                                class="example-url text-sm text-emerald-400 hover:text-emerald-300 block hover:underline">
                                https://github.com/torvalds/linux
                            </button>
                            <button
                                class="example-url text-sm text-emerald-400 hover:text-emerald-300 block hover:underline">
                                https://github.com/facebook/react
                            </button>
                            <button
                                class="example-url text-sm text-emerald-400 hover:text-emerald-300 block hover:underline">
                                https://github.com/microsoft/vscode
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="reportLoadingSection" class="hidden text-center py-16">
                    <div class="inline-flex items-center justify-center w-14 h-14 bg-slate-800/50 rounded-full mb-4">
                        <div class="w-10 h-10 border-3 border-slate-700 border-t-emerald-500 rounded-full animate-spin">
                        </div>
                    </div>
                    <h3 class="text-lg font-medium text-slate-50 mb-2">AI Analysis in Progress</h3>
                    <p class="text-sm text-slate-400">Analyzing repository with Llama 3.3 70B</p>
                    <p class="text-xs text-slate-500 mt-2">This may take 10-20 seconds</p>
                </div>

                <!-- Preview Section -->
                <div id="reportPreviewSection" class="hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-slate-50">Report Preview</h3>
                        <button id="downloadReportBtn"
                            class="btn-hover px-4 py-2 bg-emerald-500 text-slate-900 rounded-lg font-medium hover:bg-emerald-600 transition-colors flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download PDF
                        </button>
                    </div>
                    <div class="bg-brand-100 rounded-lg p-2 border border-brand-200">
                        <iframe id="pdfPreview" class="w-full h-[500px] bg-white rounded-lg"></iframe>
                    </div>
                    <div class="mt-4 flex justify-center">
                        <button id="generateAnotherBtn"
                            class="px-4 py-2 text-brand-600 hover:text-brand-700 font-medium transition-colors hover:bg-brand-50 rounded-lg">
                            ‚Üê Generate Another Report
                        </button>
                    </div>
                </div>

                <!-- Error Section -->
                <div id="reportErrorSection" class="hidden">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                        <div class="inline-flex items-center justify-center w-12 h-12 bg-red-100 rounded-full mb-4">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-red-900 mb-2">Error Generating Report</h3>
                        <p id="reportErrorMessage" class="text-sm text-red-700 mb-4"></p>
                        <button id="tryAgainBtn"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors">
                            Try Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    marked.use({ breaks: true, gfm: true });

    let conversationId = null;
    let isLoading = false;
    let currentStreamingMessage = null;
    let currentUser = null;

    const chatForm = document.getElementById('chatForm');
    const promptInput = document.getElementById('promptInput');
    const messagesContainer = document.getElementById('messagesContainer');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const sendBtn = document.getElementById('sendBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const modelSelect = document.getElementById('modelSelect');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');

    // ===== Navigation Dropdown =====
    const navDropdownBtn = document.getElementById('navDropdownBtn');
    const navDropdown = document.getElementById('navDropdown');

    navDropdownBtn?.addEventListener('click', function (e) {
        e.stopPropagation();
        navDropdown.classList.toggle('hidden');
    });

    document.addEventListener('click', function (e) {
        if (!navDropdown.classList.contains('hidden') && !navDropdownBtn?.contains(e.target)) {
            navDropdown.classList.add('hidden');
        }
    });

    // ===== Authentication Management =====
    const authenticatedUser = document.getElementById('authenticatedUser');
    const guestUser = document.getElementById('guestUser');
    const userMenuBtn = document.getElementById('userMenuBtn');
    const userDropdown = document.getElementById('userDropdown');
    const logoutBtn = document.getElementById('logoutBtn');

    // Check authentication status
    async function checkAuth() {
        try {
            const response = await fetch('/api/auth/api/me/', {
                credentials: 'include'
            });

            if (response.ok) {
                currentUser = await response.json();
                updateUserUI(currentUser);
            } else {
                // If not authenticated, redirect to login
                window.location.href = '/auth/login/';
            }
        } catch (error) {
            console.error('Auth check error:', error);
            window.location.href = '/auth/login/';
        }
    }

    // Update UI for authenticated user
    function updateUserUI(user) {
        authenticatedUser.classList.remove('hidden');
        guestUser.classList.add('hidden');

        // Set user initials
        const initials = user.first_name && user.last_name
            ? (user.first_name[0] + user.last_name[0]).toUpperCase()
            : user.name ? user.name.substring(0, 2).toUpperCase() : user.email.substring(0, 2).toUpperCase();
        document.getElementById('userInitials').textContent = initials;

        // Set user name
        const displayName = user.name || user.email.split('@')[0];
        document.getElementById('dropdownUserName').textContent = displayName;
        document.getElementById('dropdownUserEmail').textContent = user.email;
    }

    // Toggle user dropdown
    userMenuBtn?.addEventListener('click', function (e) {
        e.stopPropagation();
        userDropdown.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function (e) {
        if (!userDropdown.classList.contains('hidden') && !userMenuBtn?.contains(e.target)) {
            userDropdown.classList.add('hidden');
        }
    });

    // Handle logout
    logoutBtn?.addEventListener('click', async function () {
        try {
            await fetch('/api/auth/api/logout/', {
                method: 'POST',
                credentials: 'include'
            });
            window.location.href = '/auth/login/';
        } catch (error) {
            console.error('Logout error:', error);
            window.location.href = '/auth/login/';
        }
    });

    // Check auth on page load
    checkAuth();


    // Auto-resize textarea
    promptInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // Handle Enter key
    promptInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!isLoading) chatForm.dispatchEvent(new Event('submit'));
        }
    });

    // Suggestion buttons
    document.querySelectorAll('.suggestion-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            promptInput.value = this.textContent.trim();
            promptInput.focus();
            promptInput.dispatchEvent(new Event('input'));
        });
    });

    // Add message
    function addMessage(content, role = 'user', isStreaming = false) {
        if (welcomeMessage) welcomeMessage.style.display = 'none';

        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} mb-4 message-enter`;

        const bubble = document.createElement('div');
        bubble.className = `max-w-[85%] sm:max-w-[75%] rounded-lg px-4 py-3 text-sm markdown-body ${role === 'user'
            ? 'bg-emerald-500/20 text-slate-50 user-message border border-emerald-500/30'
            : 'bg-slate-800 border border-slate-700 text-slate-200 ai-message'
            }`;

        if (isStreaming) {
            bubble.id = 'streaming-message';
            bubble.innerHTML = content;
        } else {
            try {
                const parsed = marked.parse(content);
                const sanitized = DOMPurify.sanitize(parsed);
                bubble.innerHTML = sanitized;
            } catch (e) {
                bubble.textContent = content;
            }
        }

        messageDiv.appendChild(bubble);
        messagesContainer.appendChild(messageDiv);

        // Smooth scroll to bottom
        const scrollToBottom = (smooth = false) => {
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: smooth ? 'smooth' : 'auto'
            });
        };

        scrollToBottom(false);
        requestAnimationFrame(() => {
            scrollToBottom(true);
            setTimeout(() => scrollToBottom(true), 50);
        });

        return bubble;
    }

    // Update streaming message
    function updateStreamingMessage(content) {
        const bubble = document.getElementById('streaming-message');
        if (bubble) {
            try {
                const parsed = marked.parse(content);
                const sanitized = DOMPurify.sanitize(parsed);
                bubble.innerHTML = sanitized;
            } catch (e) {
                bubble.textContent = content;
            }

            const scrollToBottom = (smooth = true) => {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: smooth ? 'smooth' : 'auto'
                });
            };

            scrollToBottom(false);
            requestAnimationFrame(() => scrollToBottom(true));
        }
    }

    // Show/hide loading
    function setLoading(loading) {
        isLoading = loading;
        sendBtn.disabled = loading;
        if (!loading) {
            loadingOverlay.classList.add('hidden');
        }
    }

    // Show AI thinking indicator
    function showTypingIndicator() {
        if (welcomeMessage) welcomeMessage.style.display = 'none';

        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex justify-start mb-4 message-enter';
        messageDiv.id = 'typing-indicator-wrapper';

        const bubble = document.createElement('div');
        bubble.className = 'max-w-[85%] sm:max-w-[75%] rounded-lg bg-white border border-brand-200 shadow-sm';

        bubble.innerHTML = `
            <div class="ai-thinking">
                <div class="ai-thinking-icon">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <div class="ai-thinking-content">
                    <span class="ai-thinking-text">Thinking...</span>
                    <div class="ai-thinking-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        `;

        messageDiv.appendChild(bubble);
        messagesContainer.appendChild(messageDiv);

        const scrollToBottom = (smooth = true) => {
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: smooth ? 'smooth' : 'auto'
            });
        };

        scrollToBottom(false);
        requestAnimationFrame(() => scrollToBottom(true));
    }

    // Hide typing indicator
    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator-wrapper');
        if (indicator) indicator.remove();
    }

    // Handle form submission with streaming
    chatForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        const prompt = promptInput.value.trim();
        if (!prompt || isLoading) return;

        addMessage(prompt, 'user');
        promptInput.value = '';
        promptInput.style.height = 'auto';
        setLoading(true);
        showTypingIndicator();

        try {
            const requestBody = {
                prompt: prompt,
                model_id: parseInt(modelSelect.value)
            };

            if (conversationId) {
                requestBody.conversation_id = conversationId;
            }

            const response = await fetch('/api/chat/stream/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) throw new Error('Network response was not ok');

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let fullResponse = '';
            let messageBubble = null;

            hideTypingIndicator();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.slice(6));

                        if (data.type === 'conversation_id') {
                            conversationId = data.conversation_id;
                        } else if (data.type === 'content') {
                            fullResponse += data.content;

                            if (!messageBubble) {
                                messageBubble = addMessage(fullResponse, 'assistant', true);
                            } else {
                                updateStreamingMessage(fullResponse);
                            }
                        } else if (data.type === 'error') {
                            if (!messageBubble) {
                                addMessage(`‚ö†Ô∏è ${data.error}`, 'assistant');
                            }
                        } else if (data.done) {
                            if (messageBubble) messageBubble.removeAttribute('id');
                        }
                    }
                }
            }

        } catch (error) {
            console.error('Error:', error);
            hideTypingIndicator();
            addMessage('‚ö†Ô∏è Sorry, there was an error. Please try again.', 'assistant');
        } finally {
            setLoading(false);
        }
    });

    // Clear history
    clearHistoryBtn.addEventListener('click', async function () {
        const hasMessages = messagesContainer.querySelectorAll('.message-enter').length > 0;
        if (!conversationId && !hasMessages) return;
        if (!confirm('Clear conversation history?')) return;

        try {
            const messages = messagesContainer.querySelectorAll('.message-enter');
            messages.forEach(msg => msg.remove());

            if (welcomeMessage) welcomeMessage.style.display = 'block';

            const currentConversationId = conversationId;
            conversationId = null;

            if (currentConversationId) {
                await fetch('/api/chat/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: 'Clear history',
                        conversation_id: currentConversationId,
                        clear_history: true
                    })
                }).catch(() => { });
            }
        } catch (error) {
            console.error('Error clearing history:', error);
        }
    });

    // ===== Report Generation Modal =====
    const reportModal = document.getElementById('reportModal');
    const generateReportBtn = document.getElementById('generateReportBtn');
    const closeReportModal = document.getElementById('closeReportModal');
    const repoUrlInput = document.getElementById('repoUrlInput');
    const generateBtn = document.getElementById('generateBtn');
    const downloadReportBtn = document.getElementById('downloadReportBtn');
    const generateAnotherBtn = document.getElementById('generateAnotherBtn');
    const tryAgainBtn = document.getElementById('tryAgainBtn');

    const reportInputSection = document.getElementById('reportInputSection');
    const reportLoadingSection = document.getElementById('reportLoadingSection');
    const reportPreviewSection = document.getElementById('reportPreviewSection');
    const reportErrorSection = document.getElementById('reportErrorSection');
    const pdfPreview = document.getElementById('pdfPreview');
    const reportErrorMessage = document.getElementById('reportErrorMessage');

    let currentPdfData = null;
    let currentFilename = null;

    generateReportBtn.addEventListener('click', () => {
        reportModal.classList.remove('hidden');
        resetReportModal();
        repoUrlInput.focus();
    });

    closeReportModal.addEventListener('click', () => reportModal.classList.add('hidden'));

    reportModal.addEventListener('click', (e) => {
        if (e.target === reportModal) reportModal.classList.add('hidden');
    });

    document.querySelectorAll('.example-url').forEach(btn => {
        btn.addEventListener('click', function () {
            repoUrlInput.value = this.textContent.trim();
            repoUrlInput.focus();
        });
    });

    repoUrlInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') generateBtn.click();
    });

    generateBtn.addEventListener('click', async () => {
        const repoUrl = repoUrlInput.value.trim();

        if (!repoUrl) {
            alert('Please enter a repository URL');
            return;
        }

        if (!repoUrl.includes('github.com')) {
            alert('Please enter a valid GitHub repository URL');
            return;
        }

        reportInputSection.classList.add('hidden');
        reportErrorSection.classList.add('hidden');
        reportPreviewSection.classList.add('hidden');
        reportLoadingSection.classList.remove('hidden');

        try {
            const response = await fetch('/api/generate-report/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ repo_url: repoUrl })
            });

            const data = await response.json();

            if (!response.ok) throw new Error(data.error || 'Failed to generate report');

            currentPdfData = data.pdf_base64;
            currentFilename = data.filename;

            const pdfDataUrl = `data:application/pdf;base64,${data.pdf_base64}`;
            pdfPreview.src = pdfDataUrl;

            reportLoadingSection.classList.add('hidden');
            reportPreviewSection.classList.remove('hidden');

        } catch (error) {
            console.error('Error generating report:', error);
            reportErrorMessage.textContent = error.message || 'Failed to generate report. Please try again.';
            reportLoadingSection.classList.add('hidden');
            reportErrorSection.classList.remove('hidden');
        }
    });

    downloadReportBtn.addEventListener('click', () => {
        if (!currentPdfData || !currentFilename) return;

        const byteCharacters = atob(currentPdfData);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'application/pdf' });

        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = currentFilename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    });

    generateAnotherBtn.addEventListener('click', () => resetReportModal());
    tryAgainBtn.addEventListener('click', () => resetReportModal());

    function resetReportModal() {
        reportInputSection.classList.remove('hidden');
        reportLoadingSection.classList.add('hidden');
        reportPreviewSection.classList.add('hidden');
        reportErrorSection.classList.add('hidden');
        repoUrlInput.value = '';
        currentPdfData = null;
        currentFilename = null;
    }
</script>
{% endblock %}